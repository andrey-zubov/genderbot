<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    {% include 'help_bot/bootstrap_and_ko.html' %}

    <script src="https://api-maps.yandex.ru/2.1/?load=Geolink&amp;lang=ru_RU&amp;apikey=65f84225-226c-4cf2-aefa-4dda31ec4386"
            type="text/javascript"></script>

    {% load staticfiles %}
    <title>{% block title %}{% endblock %} - ChatBot</title>

    <style>
        {# /* scroll bar style */ #}
        /* width */
        ::-webkit-scrollbar {
            width: 5px;
        }

        /* Track */
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        /* Handle */
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        /* Handle on hover */
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>

    <script type="text/javascript">
        $(document).ready(function f1() {
            setTimeout(foo, 0);

            var bot_p = $("#bot_text").clone().removeAttr('hidden');
            var us_t = $("#user_text").clone().removeAttr('hidden');
            var btn_s = $("#btn_select").clone().removeAttr('hidden');
            var btn_length = 0;

            $("#btn_send").on("click", foo);

            function foo() {
                var bot_p_new = bot_p.clone();
                var user_t_new = us_t.clone();
                var btn_s_new = btn_s.clone();

                var us_in = $("#user_input").val();
                if (us_in === '') {
                    if ($(this).text().length < 50) {
                        {#//because Auto start with $(foo) collect all JS+Html code on $(this).text()#}
                        {#//and send it to the Chat! if -> max length on a text button (UserInput in DB)#}
                        us_in = $(this).text()
                    }
                }
                $("#chat_div").append(user_t_new.text(us_in));
                $.ajax({
                    'url':{% url 'web_chat_bot' %},
                    'data': {'us_in': us_in},
                    success: function (data) {
                        var json_data = jQuery.parseJSON(data);
                        for (var r = 0; r < btn_length; r++) {
                            {#// remove all old buttons#}
                            $("#id_new_btn").remove();
                        }
                        btn_length = json_data.btn_text.length;

                        $("#user_input").val('');
                        $("#chat_div").append(bot_p_new.html(json_data.help_text));

                        {#//auto scroll to the bottom of the chat div#}
                        $("#chat_show_hide").animate({scrollTop: $('#chat_div').prop("scrollHeight")}, 1000);

                        for (var i = 0; i < btn_length; i++) {
                            var btn_clone = btn_s_new.clone();
                            btn_clone.attr('id', 'id_new_btn').on("click", foo);
                            $("#div_add_btn").append(btn_clone.text(json_data.btn_text[i]));
                        }
                    }
                });
            }

            $("#btn_hide_chat").on("click", function () {
                $("#chat_show_hide").hide();
                $("#div_add_btn").hide();
            });
            $("#btn_open_chat").on("click", function () {
                $("#chat_show_hide").show();
                $("#div_add_btn").show();
            });
        });
    </script>

</head>

<body style="background-color: #f8f8f8; overflow: hidden">

<div class="mx-3"
     style="font-size: medium; font-weight: 200;">

    <!--CHAT TOP-->
    <div class="row justify-content-between rounded-top"
         style="background-color: #417690;
         position: fixed; top: 0; width: 100%; height: 50px;">
        <a id="btn_open_chat" class="btn border-0 ml-3 col-6" style="color: white; font-size: 24px;">Карта помощи</a>
        <a id="btn_hide_chat" class="btn border-0 mr-3 col-1">
            <img src="{% static 'img/window-close.png' %}" alt="X" height="30px">
        </a>
    </div>

    <!--CHAT BODY-->
    <div id="chat_show_hide" class="row"
         style="background-color: #f8f8f8; max-height: 450px; overflow-y: scroll; overflow-x: hidden;
         position: fixed; top: 50px; bottom: 120px; width: 100%;">
        <div id="chat_div"
             class="py-1 mx-2 d-inline-flex flex-column rounded"
             style="background-color: #f8f8f8;">
            <p hidden id="bot_text"
               class="text-left text-wrap shadow-sm border rounded m-1 px-3 p-1"
               style="background-color: #FFFFFF;"></p>
            {# <div hidden id="bot_text" class="text-left alert alert-dark text-wrap shadow-sm rounded"></div>#}
            <p hidden id="user_text"
               class="text-right text-wrap shadow-sm border rounded m-1 px-3 p-1"
               style="color: white; background-color: #8fc2db;"></p>
        </div>
    </div>

    <!--CHAT BUTTONS-->
    <div class="text-center rounded py-2 mb-2"
         style="background-color: #dedede; height: 120px; overflow-y: scroll; overflow-x: hidden;
         position: fixed; bottom: 0; width: 98%">
        <div id="div_add_btn"
             class=""
             style="">
            <button hidden id="btn_select" type="button"
                    class="btn m-1"
                    style="min-width: 200px; background-color: #8fc2db; color: white;"></button>
        </div>
    </div>

    <!--CHAT INPUT HIDDEN -->
    <div style="bottom: 1px">
        {# DO NOT DELETE !!! #}
        <label hidden for="user_input">Send msg</label>
        <input hidden id="user_input" type="text">
        <button hidden type="button" id="btn_send" class="btn btn-outline-success m-sm-1">Send</button>
    </div>

</div>

</body>
</html>